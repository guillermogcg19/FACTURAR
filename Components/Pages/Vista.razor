@page "/Vista"
@rendermode InteractiveServer
@using blazor.Components.Data
@using blazor.Components.Servicios
@using FacturaModel = blazor.Components.Data.Factura
@inject blazor.Components.Servicios.ServicioControlador ServicioControlador
@inject NavigationManager Navigation
@inject Microsoft.JSInterop.IJSRuntime JSRuntime

<div class="home-wrapper fade-in">
    <div class="home-card p-4" style="max-width: 880px; width: 100%;">

        <h2 class="text-center mb-4">📄 Facturas Registradas</h2>

        <div class="row gy-2 mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <input @bind="ServicioControlador.FiltroNombreCliente"
                           @bind:event="oninput"
                           placeholder="🔍 Filtrar Cliente..."
                           class="form-control" />

                    <button class="btn btn-outline-secondary" @onclick="BorrarFiltroNombre">
                        Borrar ❌
                    </button>
                </div>
            </div>

            <div class="col-md-6 d-flex justify-content-end">
                <select @bind="OrdenacionAuxiliar" class="form-select">
                    @foreach (var criterio in Enum.GetValues<CriterioOrdenacion>())
                    {
                        <option value="@criterio">@ObtenerTextoCriterio(criterio)</option>
                    }
                </select>
            </div>
        </div>

        <div class="d-flex gap-2 mb-4 justify-content-center flex-wrap">
            <button class="btn btn-primary" @onclick="CrearNuevaFactura">➕ Nueva Factura</button>
            <a href="/facturas-periodo" class="btn btn-outline-primary">📊 Facturas por Año/Mes</a>
        </div>

        @if (FacturasFiltradas.Any())
        {
            <table class="table table-hover table-striped text-center">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>📅 Fecha</th>
                        <th>👤 Cliente</th>
                        <th>🛒 Artículos</th>
                        <th>💰 Total</th>
                        <th>⚙️ Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var factura in FacturasFiltradas)
                    {
                        <tr class="clickable-row" @onclick="() => VerDetalle(factura.Id)">
                            <td>@factura.Id</td>
                            <td>@factura.FechaFactura.ToShortDateString()</td>
                            <td>@factura.NombreCliente</td>
                            <td>@factura.Articulos.Count</td>
                            <td>$@factura.Total.ToString("N2")</td>
                            <td>
                                <button class="btn btn-sm btn-warning me-1" @onclick="() => EditarFactura(factura.Id)">✏️</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => ConfirmarEliminar(factura.Id)">🗑️</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="alert alert-warning text-center">
                ⚠️ No hay facturas que coincidan con el filtro.
            </div>
        }

        <div class="text-center mt-3">
            <a href="/" class="btn btn-outline-dark">⬅ Regresar al Inicio</a>
        </div>

    </div>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        await ServicioControlador.CargarFiltroAsync();
        await ServicioControlador.CargarFacturasAsync();
    }

    private IEnumerable<FacturaModel> FacturasFiltradas => ServicioControlador.ObtenerFacturasFiltradas();
    private CriterioOrdenacion OrdenacionAuxiliar
    {
        get => ServicioControlador.OrdenacionSeleccionada;
        set
        {
            ServicioControlador.OrdenacionSeleccionada = value;
            StateHasChanged();
        }
    }

    private string ObtenerTextoCriterio(CriterioOrdenacion criterio) => criterio switch
    {
        CriterioOrdenacion.FechaDescendente => "Fecha (Más Reciente)",
        CriterioOrdenacion.IdDescendente => "ID (Más Alto)",
        CriterioOrdenacion.NombreClienteAscendente => "Cliente (A-Z)",
        _ => criterio.ToString()
    };

    private void BorrarFiltroNombre()
    {
        ServicioControlador.FiltroNombreCliente = string.Empty;
        StateHasChanged();
    }
    private void VerDetalle(int id) => Navigation.NavigateTo($"/detalle-factura/{id}");
    private void CrearNuevaFactura() => Navigation.NavigateTo("/nueva-factura");
    private void EditarFactura(int id) => Navigation.NavigateTo($"/editar-factura/{id}");
    private async Task ConfirmarEliminar(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"¿Eliminar Factura # {id}?"))
        {
            await ServicioControlador.EliminarFacturaAsync(id);
            StateHasChanged();
        }
    }
}
